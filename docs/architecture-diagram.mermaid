sequenceDiagram
    participant Controller as SendMoneyController<br/>(Webã‚¢ãƒ€ãƒ—ã‚¿)
    participant AppService as SendMoneyApplicationService<br/>(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
    participant DomainService as SendMoneyDomainService<br/>(ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤)
    participant Account as Account<br/>(ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£)
    participant Persistence as InMemoryAccountPersistenceAdapter<br/>(æ°¸ç¶šåŒ–ã‚¢ãƒ€ãƒ—ã‚¿)
    
    Note over Controller,Persistence: âœ… å›³3.6æº–æ‹ : ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã‚’åˆ†é›¢

    Controller->>AppService: sendMoney(command)
    
    rect rgb(255, 240, 200)
    Note over AppService: â‘  äº‹å‰æ¤œè¨¼<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ ç›®çš„:<br/>ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å¦¥å½“æ€§ã‚’ç¢ºèª<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’<br/>æ—©æœŸã«æ‹’å¦ã™ã‚‹
    AppService->>DomainService: isWithinThreshold(money, threshold)
    DomainService-->>AppService: true/false
    end
    
    rect rgb(200, 240, 255)
    Note over AppService: â‘¡ ãƒ‡ãƒ¼ã‚¿å–å¾—<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ ç›®çš„:<br/>ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œã«<br/>å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>é€ä¿¡ãƒãƒ¼ãƒˆã‚’ä½¿ã£ã¦<br/>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰
    AppService->>Persistence: loadAccount(sourceAccountId, baselineDate)
    Persistence-->>AppService: sourceAccount
    AppService->>Persistence: loadAccount(targetAccountId, baselineDate)
    Persistence-->>AppService: targetAccount
    end
    
    rect rgb(200, 255, 200)
    Note over AppService: â‘¢ ãƒªã‚½ãƒ¼ã‚¹ãƒ­ãƒƒã‚¯<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ ç›®çš„:<br/>ä¸¦è¡Œå‡¦ç†ã§ã®<br/>ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã‚’é˜²ã<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>åŒæ™‚ã«åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒ<br/>æ“ä½œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
    AppService->>Persistence: lockAccount(sourceAccountId)
    AppService->>Persistence: lockAccount(targetAccountId)
    end
    
    rect rgb(255, 220, 255)
    Note over AppService: â‘£ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ ç›®çš„:<br/>ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã«<br/>ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å§”è­²<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã¯<br/>ãƒ‰ãƒ¡ã‚¤ãƒ³çŸ¥è­˜ã‚’æŒãŸãªã„
    AppService->>DomainService: executeTransfer(sourceAccount, targetAccount, money)
    
    Note over DomainService: ç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯<br/>ï¼ˆãƒãƒ¼ãƒˆã‚’çŸ¥ã‚‰ãªã„ï¼‰
    
    DomainService->>Account: withdraw(money, targetAccountId)
    Account-->>DomainService: true/false
    DomainService->>Account: deposit(money, sourceAccountId)
    Account-->>DomainService: true/false
    
    DomainService-->>AppService: true/false
    end
    
    rect rgb(200, 240, 255)
    Note over AppService: â‘¤ æ°¸ç¶šåŒ–<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ ç›®çš„:<br/>ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®çµæœã‚’<br/>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>é€ä¿¡ãƒãƒ¼ãƒˆã‚’ä½¿ã£ã¦<br/>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ã‚’æ›´æ–°
    AppService->>Persistence: updateActivities(sourceAccount)
    AppService->>Persistence: updateActivities(targetAccount)
    end
    
    rect rgb(200, 255, 200)
    Note over AppService: â‘¥ ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ ç›®çš„:<br/>ãƒ­ãƒƒã‚¯ã‚’è§£æ”¾ã—ã¦<br/>ä»–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>finallyå¥ã§å¿…ãšå®Ÿè¡Œã•ã‚Œ<br/>ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã‚’é˜²ã
    AppService->>Persistence: releaseAccount(sourceAccountId)
    AppService->>Persistence: releaseAccount(targetAccountId)
    end
    
    AppService-->>Controller: true/false

    rect rgb(255, 255, 255)
    Note over Controller,Persistence: ğŸ“Š å…¨ä½“ã®æµã‚Œã®ç›®çš„<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ è²¬å‹™ã®åˆ†é›¢ï¼ˆå›³3.6ã®å®Ÿç¾ï¼‰:<br/>â‘  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤: èª¿æ•´ãƒ»ãƒãƒ¼ãƒˆç®¡ç†<br/>â‘¡ ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤: ç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯<br/>â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ãŒãƒãƒ¼ãƒˆã«ä¾å­˜ã—ãªã„<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ ä¿å®ˆæ€§ã®å‘ä¸Š:<br/>ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«å¤‰æ›´ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®ã¿<br/>ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å¤‰æ›´ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã®ã¿<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§:<br/>ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’å˜ä½“ã§<br/>ãƒ†ã‚¹ãƒˆã§ãã‚‹
    end
